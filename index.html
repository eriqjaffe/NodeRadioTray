<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <title>Hello World!</title>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script type="text/javascript" src="./scripts/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree-all-deps.min.js"></script>
    <link href="./scripts/skin-win8-n/ui.fancytree.min.css" rel="stylesheet">
    <script>
        const { ipcRenderer } = require('electron');
        require('./renderer.js')
    </script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .main-body {
        height: 75%; /* 100% - 25% for the footer */
        background-color: #f0f0f0; /* Change the background color as needed */
        position: relative;
      }

      .footer {
        height: 25%;
        width: 100%;
        background-color: #333; /* Change the background color as needed */
        color: #fff; /* Change the text color as needed */
        text-align: center; /* Center align text within the footer */
        bottom: 0;
        position: absolute;
      }

      #tree {
        height: 100%; /* Set the tree's height to 100% of the parent's height */
        overflow: auto;
      }

      ul.fancytree-container {
        background-color: inherit;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="main-body">
      <div id="tree"></div>
    </div>
    <div class="footer" id="footerDiv">
      <div class="footerChild" id="editGroupDiv" style="display:none; text-align: center;">
        <form id='editGroupForm' action="">
          <table>
            <tr>
              <td style="text-align: right;">Group Name: </td>
              <td><input type='text' class='editField' name='groupName' id='groupName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Group Icon: </td>
              <td><input type='text' class='editField' name='groupIcon' id='groupIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='editGroupSubmit' value='Submit'>
        </form>
      </div>
      <div class="footerChild" id="editStationDiv" style="display:none; text-align:center;">
        <form id='editStationForm' action="">
          <table>
            <tr>
              <td style="text-align: right;">Station Name: </td>
              <td><input type='text' class='editField' name='stationName' id='stationName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station URL: </td>
              <td><input type='url' class='editField' name='stationURL' type="url" id='stationURL' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station Icon: </td>
              <td><input type='text' class='editField' name='stationIcon' id='stationIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='editStationSubmit' value='Submit'>
        </form>
      </div>
      <div class="footerChild" id="newGroupDiv" style="display:none; text-align:center;">
        ADD A NEW GROUP
        <form id='newGroupForm' action="">
          <table>
            <tr>
              <td style="text-align: right;">Group Name: </td>
              <td><input type='text' class='editField' name='newGroupName' id='newGroupName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Group Icon: </td>
              <td><input type='text' class='editField' name='newGroupIcon' id='newGroupIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='newStationSubmit' value='Submit'>
        </form>
      </div>
      <div class="footerChild" id="newStationDiv" style="display:none; text-align:center;">
        <form id='newStationForm' action="">
          ADD A NEW STATION
          <table>
            <tr>
              <td style="text-align: right;">Station Name: </td>
              <td><input type='text' class='editField' name='newStationName' id='newStationName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station URL: </td>
              <td><input type='url' class='editField' name='newStationURL' type="url" id='newStationURL' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station Group: </td>
              <td><select name="newStationGroup" id="newStationGroup" style="width:500px;"></select></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station Icon: </td>
              <td><input type='text' class='editField' name='newStationIcon' id='newStationIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='newStationSubmit' value='Submit'>
        </form>
      </div>
    </div>
    
  </body>
  <script>
    ipcRenderer.send('test-ipc', null)

    ipcRenderer.on('get-bookmarks', (event, response) => {
      console.log(response)
      $("#tree").fancytree({
        source: convertToFancytreeFormat(response),
        activate: function(event, data){
          $(".footerChild").css("display","none")
          $(".editField").val("")
          let node = data.node
          if (node.type == "group") {
            $("#groupName").val(node.title)
            $("#groupIcon").val(node.data.img)
            $("#editGroupDiv").css("display","inline-block")
          } else {
            $("#stationName").val(node.title)
            $("#stationIcon").val(node.data.img)
            $("#stationURL").val(node.data.url)
            $("#editStationDiv").css("display","inline-block")
          }
        }
      })
    })

    ipcRenderer.on('addGroup', (event, data) => {
      $(".footerChild").css("display","none")
      $(".editField").val("")
      $("#newGroupDiv").css("display","inline-block")
    })

    ipcRenderer.on('addStation', (event, data) => {
      $("#newStationGroup").empty();
      const tree = $.ui.fancytree.getTree("#tree").getRootNode()
      tree.visit(function(node){
        if (node.type == "group") {
          $('#newStationGroup').append($('<option>', {
            value: node.title,
            text: node.title
          }));
        }
      })
      $(".footerChild").css("display","none")
      $(".editField").val("")
      $("#newStationDiv").css("display","inline-block")
    })

    ipcRenderer.on('save', (event, data) => {
      convertToOriginalJSONFormat()
    });

    $("#editGroupForm").on("submit",function(e) {
      e.preventDefault()
      let nodeToEdit = $("#tree").fancytree("getActiveNode")
      nodeToEdit.setTitle($("#groupName").val())
      nodeToEdit.data.img = $("#groupIcon").val()
      nodeToEdit.parent.sortChildren(null, true)
    })

    $("#editStationForm").on("submit",function(e) {
      e.preventDefault()
      let nodeToEdit = $("#tree").fancytree("getActiveNode")
      nodeToEdit.setTitle($("#stationName").val())
      nodeToEdit.data.img = $("#stationIcon").val()
      nodeToEdit.data.url = $("#stationURL").val()
      nodeToEdit.parent.sortChildren(null, true)
    })

    $("#newGroupForm").on("submit",function(e) {
      e.preventDefault()
      const tree = $.ui.fancytree.getTree("#tree").getRootNode()
      tree.addChildren({ title: $("#newGroupName").val(), folder: true, type: "group" })
      tree.sortChildren(null, true)
    })

    $("#newStationForm").on("submit",function(e) {
      e.preventDefault()
      const tree = $.ui.fancytree.getTree("#tree")
      const node = tree.findFirst(function(node) {
        return node.type == "group" && node.title == $("#newStationGroup").val()
      })
      node.addChildren({ title: $("#newStationName").val(), type: "bookmark", url: $("#newStationURL").val(), img: $("#newStationIcon").val() })
      node.sortChildren(null, true)
    })

    function convertToFancytreeFormat(data) {
      // Initialize an empty array to store the transformed data
      const transformedData = [];

      // Iterate over the original JSON data
      data.forEach(category => {
        const folderItem = {
          title: category.name,
          folder: true,
          img: "",
          children: [],
          type: 'group'
        };

        category.bookmark.forEach(bookmark => {
          folderItem.children.push({
            title: bookmark.name,
            url: bookmark.url,
            img: bookmark.img,
            type: 'bookmark'
          });
        });

        transformedData.push(folderItem);
      });

      return transformedData;
    }

    function convertToOriginalJSONFormat() {
      // Initialize an empty array to store the transformed data
      const originalJSONData = [];

      // get Fancytree data
      const data = $.ui.fancytree.getTree("#tree").rootNode.children

      // Iterate over the Fancytree data
      data.forEach(folderItem => {
        const category = {
          name: folderItem.title,
          img: "",
          bookmark: [],
        };

        folderItem.children.forEach(bookmarkItem => {
          category.bookmark.push({
            name: bookmarkItem.title,
            url: bookmarkItem.data.url || "", // Add a default value for url if it doesn't exist
            img: bookmarkItem.data.img || "", // Add a default value for img if it doesn't exist
          });
        });

        originalJSONData.push(category);
      });

      console.log(originalJSONData)
      ipcRenderer.send('save-bookmarks', JSON.stringify(originalJSONData, null, 3))
    }
  </script>
</html>