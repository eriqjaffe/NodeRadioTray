<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <title>Hello World!</title>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script type="text/javascript" src="./scripts/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree-all-deps.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree.dnd5.js"></script>
    <script type="text/javascript" src="./scripts/jquery.contextMenu.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree.contextMenu.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link href="./scripts/skin-win8-n/ui.fancytree.min.css" rel="stylesheet">
    <link href="./scripts/jquery.contextMenu.css" rel="stylesheet" type='text/css'/>
    <script>
        const { ipcRenderer } = require('electron');
        require('./renderer.js')
        let treeModified = false;
    </script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: "Outfit", sans-serif;
      }

      input {
        font-family: "Outfit", sans-serif;
      }

      .fancytree-title {
        font-family: "Outfit", sans-serif!important;
      }

      .main-body {
        height: 75%; /* 100% - 25% for the footer */
        background-color: #f0f0f0; /* Change the background color as needed */
        position: relative;
      }

      .footer {
        height: 25%;
        width: 100%;
        background-color: #333; /* Change the background color as needed */
        color: #fff; /* Change the text color as needed */
        text-align: center; /* Center align text within the footer */
        bottom: 0;
        position: absolute;
      }

      #tree {
        height: 100%; /* Set the tree's height to 100% of the parent's height */
        overflow: auto;
      }

      ul.fancytree-container {
        background-color: inherit;
        border: none;
      }

      .context-menu-list .context-menu-icon.context-menu-icon--fa { 
        font-family: "Outfit", sans-serif!important;
        
      }

      .context-menu-item {
        padding: 2px 2px 2px 10px!important;
        font-size: .8em!important;
      }
    </style>
  </head>
  <body>
    <div class="main-body">
      <div id="tree"></div>
    </div>
    <div class="footer" id="footerDiv">
      <div class="footerChild" id="editGroupDiv" style="display:none; text-align: center;">
        <b>EDITING GROUP "<span class="editName" id="editGroupName"></span>"</b>
        <form id='editGroupForm' action="">
          <table>
            <tr>
              <td style="text-align: right;">Group Name: </td>
              <td><input type='text' class='editField' name='groupName' id='groupName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Group Icon: </td>
              <td><input type='text' class='editField' name='groupIcon' id='groupIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='editGroupSubmit' value='Submit'>
          <input type="button" id="deleteGroup" value="Delete Group">
          <input type="button" class="cancelButton" value="Cancel">
        </form>
      </div>
      <div class="footerChild" id="editStationDiv" style="display:none; text-align:center;">
        <b>EDITING STATION "<span class="editName" id="editStationName"></span>"</b>
        <form id='editStationForm' action="">
          <table>
            <tr>
              <td style="text-align: right;">Station Name: </td>
              <td><input type='text' class='editField' name='stationName' id='stationName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station URL: </td>
              <td><input type='url' class='editField' name='stationURL' type="url" id='stationURL' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station Icon: </td>
              <td><input type='text' class='editField' name='stationIcon' id='stationIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='editStationSubmit' value='Submit'>
          <input type="button" id="deleteStation" value="Delete Station">
          <input type="button" class="cancelButton" value="Cancel">
        </form>
      </div>
      <div class="footerChild" id="newGroupDiv" style="display:none; text-align:center;">
        <b>ADD A NEW GROUP</b>
        <form id='newGroupForm' action="">
          <table>
            <tr>
              <td style="text-align: right;">Group Name: </td>
              <td><input type='text' class='editField' name='newGroupName' id='newGroupName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Group Icon: </td>
              <td><input type='text' class='editField' name='newGroupIcon' id='newGroupIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='newStationSubmit' value='Submit'>
          <input type="button" class="cancelButton" value="Cancel">
        </form>
      </div>
      <div class="footerChild" id="newStationDiv" style="display:none; text-align:center;">
        <form id='newStationForm' action="">
          <b>ADD A NEW STATION</b>
          <table>
            <tr>
              <td style="text-align: right;">Station Name: </td>
              <td><input type='text' class='editField' name='newStationName' id='newStationName' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station URL: </td>
              <td><input type='url' class='editField' name='newStationURL' type="url" id='newStationURL' value='' required style="width:500px;"></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station Group: </td>
              <td><select name="newStationGroup" id="newStationGroup" style="width:500px;"></select></td>
            </tr>
            <tr>
              <td style="text-align: right;">Station Icon: </td>
              <td><input type='text' class='editField' name='newStationIcon' id='newStationIcon' value='' style="width:500px;"></td>
            </tr>
          </table>
          <input type='submit' id='newStationSubmit' value='Submit'>
          <input type="button" class="cancelButton" value="Cancel">
        </form>
      </div>
    </div>
    
  </body>
  <script>
    ipcRenderer.send('test-ipc', null)

    ipcRenderer.on('get-bookmarks', (event, response) => {
      $("#tree").fancytree({
        extensions: ["dnd5"],
        source: convertToFancytreeFormat(response),
        dnd5: {
          autoExpandMS: 200,      
          dropMarkerOffsetX: -24,  
          dropMarkerInsertOffsetX: -16, 
          multiSource: true,                
          preventForeignNodes: true,   
          preventNonNodes: false,       
          preventRecursion: true,  
          preventVoidMoves: true,     
          scroll: true,        
          scrollSensitivity: 20,        
          scrollSpeed: 5,               
          dragStart: function (node, data) {
            if (node.type == "group") {
              return false
            } else {
              data.dropEffect = "move";
              return true
            }
          },
          dragDrag: function (node, data) {
              //console.log('dragDrag');
          }, 
          dragEnd: function (node, data) {
              //console.log('dragEnd');
          },         
          dragEnter: function (node, data) {
            if (node.type == "group") {
              return true
            } else {
              return false
            }
          },      
          dragOver: function (node, data) {
              //console.log('dragOver');
          },     
          dragExpand: function (node, data) {
              //console.log('dragExpand');
          },      
          dragDrop: function (node, data) {
              data.otherNode.moveTo(node, data.hitMode);
              node.sortChildren(null, true)
              //console.log('dragDrop')
          },
          dragLeave: function (node, data) {
              //console.log('dragLeave');
          }
      },
        modifyChild: function(event, data) {
            treeModified = true;
            $(".main-body").css("background-color","#FAA0A0")
        },
        rename: function(event, data) {
            treeModified = true;
            $(".main-body").css("background-color","#FAA0A0")
            console.log(treeModified)
        },
        remove: function(event, data) {
            treeModified = true;
            $(".main-body").css("background-color","#FAA0A0")
        },
        click: function(event, data){
          $(".footerChild").css("display","none")
          $(".editField").val("")
          let node = data.node
          if (node.type == "group") {
            $("#groupName").val(node.title)
            $("#groupIcon").val(node.data.img)
            $("#editGroupDiv").css("display","inline-block")
            $("#editGroupName").html(node.title.toUpperCase())
          } else {
            $("#stationName").val(node.title)
            $("#stationIcon").val(node.data.img)
            $("#stationURL").val(node.data.url)
            $("#editStationDiv").css("display","inline-block")
            $("#editStationName").html(node.title.toUpperCase())
          }
        },
        activate: function(event, data){
          $(".footerChild").css("display","none")
          $(".editField").val("")
          let node = data.node
          if (node.type == "group") {
            $("#groupName").val(node.title)
            $("#groupIcon").val(node.data.img)
            $("#editGroupDiv").css("display","inline-block")
            $("#editGroupName").html(node.title.toUpperCase())
          } else {
            $("#stationName").val(node.title)
            $("#stationIcon").val(node.data.img)
            $("#stationURL").val(node.data.url)
            $("#editStationDiv").css("display","inline-block")
            $("#editStationName").html(node.title.toUpperCase())
          }
        }
      })
    })

    $.contextMenu({
      selector: "span.fancytree-title",
      build: function($triggerElement, e){
        let node = $.ui.fancytree.getNode($triggerElement)
        if (node.type == "group") {
          cmItems = {
            "add": {name: "Add Station"},
            "delete": {name: "Delete Group"}
          }
        } else {
          cmItems = {
            "delete": {name: "Delete Station"}
          }
        }
        return {
            callback: function(key, options){
              if (node.type == "group") {
                switch (key) {
                  case "add":
                    $("#newStationGroup").empty()
                    let tree = $.ui.fancytree.getTree("#tree").getRootNode()
                    tree.visit(function(child){
                      if (child.type == "group") {
                        $('#newStationGroup').append($('<option>', {
                          value: child.title,
                          text: child.title
                        }));
                      }
                    })
                    $(".footerChild").css("display","none")
                    $(".editField").val("")
                    $("#newStationGroup").val(node.title)
                    $("#newStationDiv").css("display","inline-block")
                    break;
                  case "delete":
                  if (confirm("Are you sure you want to delete '"+node.title+"'?\r\n\r\nThis will also delete all the group's stations!")) {
                    node.remove()
                    resetStuff()
                  }
                }
              } else {
                switch (key) {
                  case "delete":
                    if (confirm("Are you sure you want to delete '"+node.title+"'?")) {
                      node.remove()
                      resetStuff()
                    }
                }
              }
            },
            items: cmItems
        };
      }
    });

    ipcRenderer.on('addGroup', (event, data) => {
      $(".footerChild").css("display","none")
      $(".editField").val("")
      $("#newGroupDiv").css("display","inline-block")
    })

    ipcRenderer.on('addStation', (event, data) => {
      $("#newStationGroup").empty();
      const tree = $.ui.fancytree.getTree("#tree").getRootNode()
      tree.visit(function(node){
        if (node.type == "group") {
          $('#newStationGroup').append($('<option>', {
            value: node.title,
            text: node.title
          }));
        }
      })
      $(".footerChild").css("display","none")
      $(".editField").val("")
      $("#newStationDiv").css("display","inline-block")
    })

    ipcRenderer.on('save', (event, source) => {
      console.log(source)
      convertToOriginalJSONFormat(source)
    });

    ipcRenderer.on('check-tree', () => {
      ipcRenderer.send('check-tree-response', treeModified);
    })

    ipcRenderer.on('save-complete', () => {
      treeModified = false;
      $(".main-body").css("background-color","#f0f0f0")
    })

    $(".cancelButton").on("click",function(e) {
      e.preventDefault()
      resetStuff()
    })

    $("#editGroupForm").on("submit",function(e) {
      e.preventDefault()
      let tree = $.ui.fancytree.getTree("#tree");
      let nodeToEdit = tree.getActiveNode();
      nodeToEdit.setTitle($("#groupName").val())
      nodeToEdit.data.img = $("#groupIcon").val()
      nodeToEdit.parent.sortChildren(null, true)
      resetStuff()
    })

    $("#editStationForm").on("submit",function(e) {
      e.preventDefault()
      let tree = $.ui.fancytree.getTree("#tree");
      let nodeToEdit = tree.getActiveNode();
      nodeToEdit.setTitle($("#stationName").val())
      nodeToEdit.data.img = $("#stationIcon").val()
      nodeToEdit.data.url = $("#stationURL").val()
      nodeToEdit.parent.sortChildren(null, true)
      resetStuff()
    })

    $("#deleteGroup").on("click", function(e) {
      let tree = $.ui.fancytree.getTree("#tree");
      let nodeToEdit = tree.getActiveNode();
      if (confirm("Are you sure you want to delete '"+nodeToEdit.title+"'?\r\n\r\nThis will also delete all the group's stations!")) {
        nodeToEdit.remove()
        resetStuff()
      }
    })

    $("#deleteStation").on("click", function(e) {
      let tree = $.ui.fancytree.getTree("#tree");
      let nodeToEdit = tree.getActiveNode();
      if (confirm("Are you sure you want to delete '"+nodeToEdit.title+"'?")) {
        nodeToEdit.remove()
        resetStuff()
      }
    })

    $("#newGroupForm").on("submit",function(e) {
      e.preventDefault()
      const tree = $.ui.fancytree.getTree("#tree").getRootNode()
      tree.addChildren({ title: $("#newGroupName").val(), folder: true, type: "group" })
      tree.sortChildren(null, true)
      resetStuff()
    })

    $("#newStationForm").on("submit",function(e) {
      e.preventDefault()
      const tree = $.ui.fancytree.getTree("#tree")
      const node = tree.findFirst(function(node) {
        return node.type == "group" && node.title == $("#newStationGroup").val()
      })
      node.addChildren({ title: $("#newStationName").val(), type: "bookmark", url: $("#newStationURL").val(), img: $("#newStationIcon").val() })
      node.sortChildren(null, true)
      let station = node.findFirst($("#newStationName").val())
      node.setExpanded()
      station.setFocus()
      station.setActive()
      station.makeVisible({scrollIntoView: true});
      resetStuff()
    })

    function convertToFancytreeFormat(data) {
      // Initialize an empty array to store the transformed data
      const transformedData = [];

      // Iterate over the original JSON data
      data.forEach(category => {
        const folderItem = {
          title: category.name,
          folder: true,
          img: "",
          children: [],
          type: 'group'
        };

        category.bookmark.forEach(bookmark => {
          folderItem.children.push({
            title: bookmark.name,
            url: bookmark.url,
            img: bookmark.img,
            type: 'bookmark'
          });
        });

        transformedData.push(folderItem);
      });

      return transformedData;
    }

    function convertToOriginalJSONFormat(source) {
      // Initialize an empty array to store the transformed data
      const originalJSONData = [];

      // get Fancytree data
      const data = $.ui.fancytree.getTree("#tree").rootNode.children

      // Iterate over the Fancytree data
      data.forEach(folderItem => {
        const category = {
          name: folderItem.title,
          img: "",
          bookmark: [],
        };

        if (folderItem.children != undefined) {
          folderItem.children.forEach(bookmarkItem => {
            category.bookmark.push({
              name: bookmarkItem.title,
              url: bookmarkItem.data.url || "", // Add a default value for url if it doesn't exist
              img: bookmarkItem.data.img || "", // Add a default value for img if it doesn't exist
            });
          });
        }

        originalJSONData.push(category);
      });

      console.log(originalJSONData)
      ipcRenderer.send('save-bookmarks', { source: source, data: JSON.stringify(originalJSONData, null, 3) })
    }

    function resetStuff() {
      $("#newStationGroup").empty();
      $(".footerChild").css("display","none")
      $(".editField").val("")
      $(".editName").html("")
    }
  </script>
</html>