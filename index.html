<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <title>Hello World!</title>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script type="text/javascript" src="./scripts/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="./scripts/jquery.fancytree-all-deps.min.js"></script>
    <link href="./scripts/skin-win8-n/ui.fancytree.min.css" rel="stylesheet">
    <script>
        const { ipcRenderer } = require('electron');
    </script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .main-body {
        height: 75%; /* 100% - 25% for the footer */
        background-color: #f0f0f0; /* Change the background color as needed */
        position: relative;
      }

      .footer {
        height: 25%;
        width: 100%;
        background-color: #333; /* Change the background color as needed */
        color: #fff; /* Change the text color as needed */
        text-align: center; /* Center align text within the footer */
        bottom: 0;
        position: absolute;
      }

      #tree {
        height: 100%; /* Set the tree's height to 100% of the parent's height */
        overflow: auto;
      }

      ul.fancytree-container {
        background-color: inherit;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="main-body">
      <div id="tree"></div>
    </div>
    <div class="footer" id="footerDiv">
      <div class="footerChild" id="editGroupDiv" style="display:none;">
        <form id='editGroupForm'>
        <label>Group Name:</label>
        <input type='text' class='editField' name='groupName' id='groupName' value='' required><br>
        <label>Group Icon:</label>
        <input type='text' class='editField' name='groupIcon' id='groupIcon' value=''><br>
        <input type='submit' id='editGroupSubmit' value='Submit'>
        </form>
      </div>
      <div class="footerChild" id="editStationDiv" style="display:none;">
        <form id='editStationForm'>
        <label>Station Name:</label>
        <input type='text' class='editField' name='stationName' id='stationName' value='' required><br>
        <label>Station URL:</label>
        <input type='url' class='editField' name='stationURL' id='stationURL' value='' required><br>
        <label>Station Icon:</label>
        <input type='text' class='editField' name='stationIcon' id='stationIcon' value=''><br>
        <input type='submit' id='editStationSubmit' value='Submit'>
        </form>
      </div>
    </div>
    
  </body>
  <script>
    ipcRenderer.send('test-ipc', null)

    ipcRenderer.on('get-bookmarks', (event, response) => {
      $("#tree").fancytree({
        source: convertToFancytreeFormat(response),
        activate: function(event, data){
          $(".footerChild").css("display","none")
          $(".editField").val("")
          let node = data.node
          if (node.type == "group") {
            $("#groupName").val(node.title)
            $("#groupIcon").val(node.data.img)
            $("#editGroupDiv").css("display","inline-block")
          } else {
            $("#stationName").val(node.title)
            $("#stationIcon").val(node.data.img)
            $("#stationURL").val(node.data.url)
            $("#editStationDiv").css("display","inline-block")
          }
        }
      })
    })

    $("#editGroupForm").on("submit",function(e) {
      e.preventDefault()
      let nodeToEdit = $("#tree").fancytree("getActiveNode")
      nodeToEdit.setTitle($("#groupName").val())
      nodeToEdit.data.img = $("#groupIcon").val()
      nodeToEdit.parent.sortChildren(null, true)
    })

    $("#editStationForm").on("submit",function(e) {
      e.preventDefault()
      let nodeToEdit = $("#tree").fancytree("getActiveNode")
      nodeToEdit.setTitle($("#stationName").val())
      nodeToEdit.data.img = $("#stationIcon").val()
      nodeToEdit.data.url = $("#stationURL").val()
      nodeToEdit.parent.sortChildren(null, true)
    })


    function convertToFancytreeFormat(data) {
      // Initialize an empty array to store the transformed data
      const transformedData = [];

      // Iterate over the original JSON data
      data.forEach(category => {
        const folderItem = {
          title: category.name,
          folder: true,
          img: "",
          children: [],
          type: 'group'
        };

        category.bookmark.forEach(bookmark => {
          folderItem.children.push({
            title: bookmark.name,
            url: bookmark.url,
            img: bookmark.img,
            type: 'bookmark'
          });
        });

        transformedData.push(folderItem);
      });

      return transformedData;
    }

    function convertToOriginalJSONFormat(data) {
      // Initialize an empty array to store the transformed data
      const originalJSONData = [];

      // Iterate over the Fancytree data
      data.forEach(folderItem => {
        const category = {
          name: folderItem.title,
          img: "",
          bookmark: [],
        };

        folderItem.children.forEach(bookmarkItem => {
          category.bookmark.push({
            name: bookmarkItem.title,
            url: bookmarkItem.url || "", // Add a default value for url if it doesn't exist
            img: bookmarkItem.img || "", // Add a default value for img if it doesn't exist
          });
        });

        originalJSONData.push(category);
      });

      return originalJSONData;
    }
  </script>
</html>